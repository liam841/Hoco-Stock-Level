<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dropbox Setup Wizard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .wizard-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 700px;
            width: 100%;
            border: 1px solid #e1e8ed;
        }
        
        h1 {
            color: #1a202c;
            margin-bottom: 8px;
            font-size: 2em;
            font-weight: 600;
        }
        
        .subtitle {
            color: #718096;
            margin-bottom: 32px;
            font-size: 0.95em;
        }
        
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #2d3748;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .step-number.completed {
            background: #22543d;
        }
        
        .step-title {
            font-size: 1.25em;
            font-weight: 600;
            color: #2d3748;
        }
        
        .step-content {
            margin-left: 44px;
        }
        
        .instruction {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .instruction ol, .instruction ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .instruction li {
            margin-bottom: 8px;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.875em;
            margin: 12px 0;
            overflow-x: auto;
            word-break: break-all;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 0.9375em;
        }
        
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.9375em;
            font-family: inherit;
        }
        
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .input-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 0.9375em;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }
        
        .btn-primary {
            background: #2d3748;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1a202c;
        }
        
        .btn-secondary {
            background: #edf2f7;
            color: #2d3748;
            border: 1px solid #cbd5e0;
            margin-right: 8px;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .btn-link {
            background: none;
            color: #4299e1;
            text-decoration: underline;
            padding: 0;
            font-size: 0.9375em;
        }
        
        .btn-link:hover {
            color: #2c5282;
        }
        
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
        }
        
        .status-message {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.875em;
            display: none;
        }
        
        .status-message.show {
            display: block;
        }
        
        .status-message.success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status-message.error {
            background: #fff5f5;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .status-message.info {
            background: #ebf8ff;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }
        
        .external-link {
            color: #4299e1;
            text-decoration: none;
        }
        
        .external-link:hover {
            text-decoration: underline;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-bottom: 32px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #4299e1;
            transition: width 0.3s;
            border-radius: 2px;
        }
        
        .copy-btn {
            background: #4299e1;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875em;
            margin-top: 8px;
        }
        
        .copy-btn:hover {
            background: #3182ce;
        }
        
        .test-result {
            margin-top: 16px;
            padding: 12px;
            border-radius: 6px;
            display: none;
        }
        
        .test-result.show {
            display: block;
        }
        
        .test-result.success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .test-result.error {
            background: #fff5f5;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .final-summary {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 24px;
            margin-top: 24px;
        }
        
        .final-summary h3 {
            margin-bottom: 16px;
            color: #2d3748;
        }
        
        .final-summary ul {
            margin-left: 20px;
            line-height: 1.8;
        }
        
        .final-summary li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="wizard-container">
        <h1>Dropbox Setup Wizard</h1>
        <p class="subtitle">Follow these steps to configure automatic file uploads to Dropbox</p>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
        
        <!-- Step 1: Get Dropbox Token -->
        <div class="step active" id="step1">
            <div class="step-header">
                <div class="step-number" id="step1Number">1</div>
                <div class="step-title">Get Dropbox Access Token</div>
            </div>
            <div class="step-content">
                <div class="instruction">
                    <p><strong>Follow these steps to get your Dropbox access token:</strong></p>
                    <ol>
                        <li>Go to <a href="https://www.dropbox.com/developers/apps" target="_blank" class="external-link">Dropbox App Console</a> (opens in new tab)</li>
                        <li>Click <strong>"Create app"</strong></li>
                        <li>Choose these settings:
                            <ul>
                                <li><strong>API:</strong> Dropbox API</li>
                                <li><strong>Access level:</strong> Full Dropbox (or App folder for more security)</li>
                                <li><strong>App name:</strong> Your app name (e.g., "CSV Uploader")</li>
                            </ul>
                        </li>
                        <li>Click <strong>"Create app"</strong></li>
                        <li>Go to the <strong>"Permissions"</strong> tab</li>
                        <li>Enable <strong>"files.content.write"</strong> permission</li>
                        <li>Go to the <strong>"Settings"</strong> tab</li>
                        <li>Under "OAuth 2", click <strong>"Generate access token"</strong></li>
                        <li>Copy the generated token (it starts with "sl.")</li>
                    </ol>
                </div>
                
                <div class="input-group">
                    <label for="dropboxToken">Paste your Dropbox Access Token here:</label>
                    <input type="password" id="dropboxToken" placeholder="sl.BxYzAbCdEfGhIjKlMnOpQrStUvWxYz..." />
                    <button class="copy-btn" onclick="toggleTokenVisibility()">Show/Hide Token</button>
                </div>
                
                <div class="button-group">
                    <div></div>
                    <button class="btn btn-primary" onclick="nextStep()">Next Step →</button>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Choose Hosting Platform -->
        <div class="step" id="step2">
            <div class="step-header">
                <div class="step-number" id="step2Number">2</div>
                <div class="step-title">Choose Your Hosting Platform</div>
            </div>
            <div class="step-content">
                <div class="instruction">
                    <p>Select where you plan to host your backend API. This determines how you'll set up environment variables.</p>
                </div>
                
                <div class="input-group">
                    <label for="hostingPlatform">Hosting Platform:</label>
                    <select id="hostingPlatform" onchange="updatePlatformInstructions()">
                        <option value="">-- Select Platform --</option>
                        <option value="netlify">Netlify Functions</option>
                        <option value="vercel">Vercel Serverless Functions</option>
                        <option value="aws">AWS Lambda</option>
                        <option value="custom">Custom Server (Express, etc.)</option>
                        <option value="local">Local Development Only</option>
                    </select>
                </div>
                
                <div id="platformInstructions" style="display: none;">
                    <div class="instruction" id="netlifyInstructions" style="display: none;">
                        <strong>Netlify Setup:</strong>
                        <ol>
                            <li>Deploy your site to Netlify (connect your GitHub repo)</li>
                            <li>Go to <strong>Site settings</strong> → <strong>Environment variables</strong></li>
                            <li>Click <strong>"Add a variable"</strong></li>
                            <li>Key: <code>DROPBOX_ACCESS_TOKEN</code></li>
                            <li>Value: (paste your token)</li>
                            <li>Click <strong>"Save"</strong></li>
                        </ol>
                    </div>
                    
                    <div class="instruction" id="vercelInstructions" style="display: none;">
                        <strong>Vercel Setup:</strong>
                        <ol>
                            <li>Deploy your site to Vercel</li>
                            <li>Go to <strong>Project Settings</strong> → <strong>Environment Variables</strong></li>
                            <li>Click <strong>"Add New"</strong></li>
                            <li>Key: <code>DROPBOX_ACCESS_TOKEN</code></li>
                            <li>Value: (paste your token)</li>
                            <li>Select environments (Production, Preview, Development)</li>
                            <li>Click <strong>"Save"</strong></li>
                        </ol>
                    </div>
                    
                    <div class="instruction" id="awsInstructions" style="display: none;">
                        <strong>AWS Lambda Setup:</strong>
                        <ol>
                            <li>Create or edit your Lambda function</li>
                            <li>Go to <strong>Configuration</strong> → <strong>Environment variables</strong></li>
                            <li>Click <strong>"Edit"</strong></li>
                            <li>Click <strong>"Add environment variable"</strong></li>
                            <li>Key: <code>DROPBOX_ACCESS_TOKEN</code></li>
                            <li>Value: (paste your token)</li>
                            <li>Click <strong>"Save"</strong></li>
                        </ol>
                    </div>
                    
                    <div class="instruction" id="customInstructions" style="display: none;">
                        <strong>Custom Server Setup:</strong>
                        <ol>
                            <li>Create a <code>.env</code> file in your server directory</li>
                            <li>Add: <code>DROPBOX_ACCESS_TOKEN=your_token_here</code></li>
                            <li>Make sure <code>.env</code> is in your <code>.gitignore</code></li>
                            <li>Use a package like <code>dotenv</code> to load environment variables</li>
                        </ol>
                    </div>
                    
                    <div class="instruction" id="localInstructions" style="display: none;">
                        <strong>Local Development Setup:</strong>
                        <ol>
                            <li>Create a <code>.env</code> file in your project root</li>
                            <li>Add: <code>DROPBOX_ACCESS_TOKEN=your_token_here</code></li>
                            <li>Make sure <code>.env</code> is in your <code>.gitignore</code></li>
                        </ol>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep()">← Previous</button>
                    <button class="btn btn-primary" onclick="nextStep()">Next Step →</button>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Configure API Endpoint -->
        <div class="step" id="step3">
            <div class="step-header">
                <div class="step-number" id="step3Number">3</div>
                <div class="step-title">Configure API Endpoint</div>
            </div>
            <div class="step-content">
                <div class="instruction">
                    <p>Enter your API endpoint URL. This should point to your serverless function or backend API.</p>
                </div>
                
                <div class="input-group">
                    <label for="apiEndpoint">API Endpoint URL:</label>
                    <input type="text" id="apiEndpoint" placeholder="/api/upload-dropbox" />
                    <small style="color: #718096; display: block; margin-top: 4px;">
                        Examples:<br>
                        • Netlify: <code>/.netlify/functions/upload-dropbox</code><br>
                        • Vercel: <code>/api/upload-dropbox</code><br>
                        • Custom: <code>https://your-api-domain.com/upload</code>
                    </small>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep()">← Previous</button>
                    <button class="btn btn-primary" onclick="nextStep()">Next Step →</button>
                </div>
            </div>
        </div>
        
        <!-- Step 4: Test Connection -->
        <div class="step" id="step4">
            <div class="step-header">
                <div class="step-number" id="step4Number">4</div>
                <div class="step-title">Test Connection (Optional)</div>
            </div>
            <div class="step-content">
                <div class="instruction">
                    <p>Test your Dropbox connection by uploading a test file. This verifies that your token and API endpoint are working correctly.</p>
                </div>
                
                <div class="input-group">
                    <button class="btn btn-primary" onclick="testConnection()">Test Dropbox Connection</button>
                </div>
                
                <div class="test-result" id="testResult"></div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep()">← Previous</button>
                    <button class="btn btn-primary" onclick="nextStep()">Skip Test & Continue →</button>
                </div>
            </div>
        </div>
        
        <!-- Step 5: Save Configuration -->
        <div class="step" id="step5">
            <div class="step-header">
                <div class="step-number" id="step5Number">5</div>
                <div class="step-title">Save Configuration</div>
            </div>
            <div class="step-content">
                <div class="instruction">
                    <p>Review your configuration and save the setup instructions.</p>
                </div>
                
                <div class="final-summary">
                    <h3>Configuration Summary</h3>
                    <ul>
                        <li><strong>Dropbox Token:</strong> <span id="summaryToken">Not set</span></li>
                        <li><strong>Hosting Platform:</strong> <span id="summaryPlatform">Not set</span></li>
                        <li><strong>API Endpoint:</strong> <span id="summaryEndpoint">Not set</span></li>
                    </ul>
                </div>
                
                <div class="input-group">
                    <label>Next Steps:</label>
                    <textarea id="nextSteps" readonly style="min-height: 200px;"></textarea>
                    <button class="copy-btn" onclick="copyNextSteps()">Copy Instructions</button>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep()">← Previous</button>
                    <button class="btn btn-primary" onclick="finishWizard()">Finish Setup ✓</button>
                </div>
            </div>
        </div>
        
        <!-- Success Screen -->
        <div class="step" id="stepComplete">
            <div class="step-content" style="text-align: center; padding: 40px 0;">
                <div style="font-size: 4em; margin-bottom: 20px;">✓</div>
                <h2 style="color: #22543d; margin-bottom: 16px;">Setup Complete!</h2>
                <p style="color: #718096; margin-bottom: 32px;">
                    Your Dropbox configuration is ready. Follow the instructions you copied to complete the setup.
                </p>
                <div class="final-summary" style="text-align: left;">
                    <h3>What to do next:</h3>
                    <ul>
                        <li>Set the <code>DROPBOX_ACCESS_TOKEN</code> environment variable in your hosting platform</li>
                        <li>Update the <code>DROPBOX_UPLOAD_API</code> constant in <code>index.html</code></li>
                        <li>Deploy your backend API function</li>
                        <li>Test by uploading a file through the website</li>
                    </ul>
                </div>
                <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 32px;">Start Over</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentStep = 1;
        const totalSteps = 5;
        let tokenVisible = false;
        
        function updateProgress() {
            const percent = ((currentStep - 1) / totalSteps) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
        }
        
        function showStep(stepNum) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(`step${stepNum}`).classList.add('active');
            currentStep = stepNum;
            updateProgress();
        }
        
        function nextStep() {
            if (currentStep < totalSteps) {
                // Validate current step
                if (currentStep === 1) {
                    const token = document.getElementById('dropboxToken').value.trim();
                    if (!token || !token.startsWith('sl.')) {
                        showStatus('Please enter a valid Dropbox access token (should start with "sl.")', 'error');
                        return;
                    }
                }
                if (currentStep === 2) {
                    const platform = document.getElementById('hostingPlatform').value;
                    if (!platform) {
                        showStatus('Please select a hosting platform', 'error');
                        return;
                    }
                }
                if (currentStep === 3) {
                    const endpoint = document.getElementById('apiEndpoint').value.trim();
                    if (!endpoint) {
                        showStatus('Please enter an API endpoint URL', 'error');
                        return;
                    }
                }
                
                if (currentStep === 4) {
                    updateSummary();
                }
                
                showStep(currentStep + 1);
                hideStatus();
            }
        }
        
        function previousStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
                hideStatus();
            }
        }
        
        function toggleTokenVisibility() {
            const input = document.getElementById('dropboxToken');
            tokenVisible = !tokenVisible;
            input.type = tokenVisible ? 'text' : 'password';
        }
        
        function updatePlatformInstructions() {
            const platform = document.getElementById('hostingPlatform').value;
            document.getElementById('platformInstructions').style.display = platform ? 'block' : 'none';
            
            // Hide all instructions
            document.querySelectorAll('#platformInstructions > div').forEach(div => {
                div.style.display = 'none';
            });
            
            // Show relevant instruction
            if (platform) {
                const instructionMap = {
                    'netlify': 'netlifyInstructions',
                    'vercel': 'vercelInstructions',
                    'aws': 'awsInstructions',
                    'custom': 'customInstructions',
                    'local': 'localInstructions'
                };
                document.getElementById(instructionMap[platform]).style.display = 'block';
            }
        }
        
        async function testConnection() {
            const token = document.getElementById('dropboxToken').value.trim();
            const endpoint = document.getElementById('apiEndpoint').value.trim();
            
            if (!token || !endpoint) {
                showStatus('Please complete previous steps first', 'error');
                return;
            }
            
            const testResult = document.getElementById('testResult');
            testResult.textContent = 'Testing connection...';
            testResult.className = 'test-result show info';
            
            // Create a test CSV file
            const testCSV = 'SKU,Stock Level\nTEST-001,10\n';
            const blob = new Blob([testCSV], { type: 'text/csv' });
            const formData = new FormData();
            formData.append('file', blob, 'test-connection.csv');
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    testResult.textContent = '✓ Connection successful! Your Dropbox setup is working correctly.';
                    testResult.className = 'test-result show success';
                } else {
                    const error = await response.json().catch(() => ({ error: 'Unknown error' }));
                    testResult.textContent = `✗ Connection failed: ${error.error || response.statusText}. Please check your token and API endpoint.`;
                    testResult.className = 'test-result show error';
                }
            } catch (error) {
                testResult.textContent = `✗ Connection error: ${error.message}. Make sure your API endpoint is correct and accessible.`;
                testResult.className = 'test-result show error';
            }
        }
        
        function updateSummary() {
            const token = document.getElementById('dropboxToken').value.trim();
            const platform = document.getElementById('hostingPlatform').value;
            const endpoint = document.getElementById('apiEndpoint').value.trim();
            
            document.getElementById('summaryToken').textContent = token ? '✓ Set (hidden)' : 'Not set';
            document.getElementById('summaryPlatform').textContent = platform ? getPlatformName(platform) : 'Not set';
            document.getElementById('summaryEndpoint').textContent = endpoint || 'Not set';
            
            // Generate next steps
            const steps = generateNextSteps(platform, token, endpoint);
            document.getElementById('nextSteps').value = steps;
        }
        
        function getPlatformName(platform) {
            const names = {
                'netlify': 'Netlify Functions',
                'vercel': 'Vercel Serverless Functions',
                'aws': 'AWS Lambda',
                'custom': 'Custom Server',
                'local': 'Local Development'
            };
            return names[platform] || platform;
        }
        
        function generateNextSteps(platform, token, endpoint) {
            let steps = 'DROPBOX SETUP INSTRUCTIONS\n';
            steps += '='.repeat(50) + '\n\n';
            
            steps += '1. SET ENVIRONMENT VARIABLE\n';
            steps += '   In your hosting platform, set:\n';
            steps += '   Key: DROPBOX_ACCESS_TOKEN\n';
            steps += `   Value: ${token}\n\n`;
            
            if (platform === 'netlify') {
                steps += '   Netlify: Site Settings → Environment Variables\n';
            } else if (platform === 'vercel') {
                steps += '   Vercel: Project Settings → Environment Variables\n';
            } else if (platform === 'aws') {
                steps += '   AWS Lambda: Configuration → Environment Variables\n';
            } else {
                steps += '   Create a .env file with: DROPBOX_ACCESS_TOKEN=' + token + '\n';
            }
            
            steps += '\n2. UPDATE INDEX.HTML\n';
            steps += '   In index.html, update the API endpoint:\n';
            steps += '   const DROPBOX_UPLOAD_API = \'' + endpoint + '\';\n\n';
            
            steps += '3. DEPLOY BACKEND API\n';
            if (platform === 'netlify') {
                steps += '   - Create netlify/functions/upload-dropbox.js\n';
                steps += '   - Copy code from api/upload-dropbox-node.js\n';
                steps += '   - Deploy to Netlify\n';
            } else if (platform === 'vercel') {
                steps += '   - Create api/upload-dropbox.js\n';
                steps += '   - Copy code from api/upload-dropbox-node.js\n';
                steps += '   - Deploy to Vercel\n';
            } else {
                steps += '   - Set up your backend API server\n';
                steps += '   - Use the code from api/upload-dropbox-node.js\n';
            }
            
            steps += '\n4. TEST THE SETUP\n';
            steps += '   - Upload a file through your website\n';
            steps += '   - Check your Dropbox folder: /TestStock/\n\n';
            
            steps += 'SECURITY NOTES:\n';
            steps += '- Never commit your Dropbox token to Git\n';
            steps += '- Always use environment variables\n';
            steps += '- See SECURITY.md for more information\n';
            
            return steps;
        }
        
        function copyNextSteps() {
            const textarea = document.getElementById('nextSteps');
            textarea.select();
            document.execCommand('copy');
            showStatus('Instructions copied to clipboard!', 'success');
        }
        
        function finishWizard() {
            showStep('Complete');
            document.getElementById('progressFill').style.width = '100%';
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message show ${type}`;
        }
        
        function hideStatus() {
            document.getElementById('statusMessage').classList.remove('show');
        }
        
        // Initialize
        updateProgress();
    </script>
</body>
</html>
